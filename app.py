import streamlit as st
import pandas as pd
from datetime import datetime

# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ß‡∏±‡∏™‡∏î‡∏∏ Pro", layout="wide")

# ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á CSS ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏î‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
    html, body, [class*="css"] { font-family: 'Sarabun', sans-serif; }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Metric ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏´‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡πà‡∏ô */
    [data-testid="stMetricValue"] {
        font-size: 36px !important;
        font-weight: 800 !important;
        color: #000000 !important; /* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏µ‡∏î‡∏≥‡πÄ‡∏Ç‡πâ‡∏° */
    }
    [data-testid="stMetricLabel"] {
        font-size: 18px !important;
        font-weight: bold !important;
        color: #1a1a1a !important;
    }

    /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á Metric ‡πÅ‡∏ö‡∏ö High Contrast */
    div[data-testid="stMetric"]:nth-child(1) { background-color: #D1D5DB; border: 2px solid #9CA3AF; } /* ‡∏´‡∏¥‡∏ô‡πÉ‡∏´‡∏ç‡πà - ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏° */
    div[data-testid="stMetric"]:nth-child(2) { background-color: #9CA3AF; border: 2px solid #4B5563; } /* ‡∏´‡∏¥‡∏ô‡∏¢‡πà‡∏≠‡∏¢ - ‡πÄ‡∏ó‡∏≤ */
    div[data-testid="stMetric"]:nth-child(3) { background-color: #FDE68A; border: 2px solid #F59E0B; } /* ‡∏ó‡∏£‡∏≤‡∏¢ - ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
    div[data-testid="stMetric"]:nth-child(4) { background-color: #A7F3D0; border: 2px solid #10B981; } /* ‡∏õ‡∏π‡∏ô - ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏î‡πà‡∏ô */
    div[data-testid="stMetric"]:nth-child(5) { background-color: #BFDBFE; border: 2px solid #3B82F6; } /* ‡∏´‡∏¥‡∏ô‡∏Ñ‡∏•‡∏∏‡∏Å - ‡∏ü‡πâ‡∏≤ */

    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á Input ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡∏ç‡πà */
    input { font-size: 20px !important; font-weight: bold !important; }
    
    /* ‡∏Å‡∏£‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô */
    .stExpander {
        border: 2px solid #1a1a1a !important;
        background-color: #ffffff !important;
        border-radius: 10px !important;
        box-shadow: 3px 3px 0px #000000;
    }
    </style>
""", unsafe_allow_html=True)

@st.cache_data
def load_data():
    file_name = "‡πÄ‡∏ó‡∏™‡∏ï‡∏≤‡∏£‡∏≤‡∏á.csv"
    for enc in ['cp874', 'tis-620', 'utf-8-sig']:
        try:
            df = pd.read_csv(file_name, skiprows=2, header=None, encoding=enc, on_bad_lines='skip')
            return df
        except: continue
    return None

if 'calc_history' not in st.session_state:
    st.session_state.calc_history = []

st.title("üèóÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡∏±‡∏™‡∏î‡∏∏ (Full Report)")

try:
    df = load_data()
    if df is not None:
        # ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
        col_p1, col_p2 = st.columns([3, 1])
        project_name = col_p1.text_input("üè¢ ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡πÑ‡∏ã‡∏ï‡πå‡∏á‡∏≤‡∏ô:", value="‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà")
        calc_date = datetime.now().strftime("%d/%m/%Y")
        col_p2.text_input("üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:", value=calc_date, disabled=True)
            
        # ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô
        with st.expander("üìä 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô (Planned)", expanded=False):
            col_plan = st.columns(5)
            p_names = ["‡∏´‡∏¥‡∏ô‡πÉ‡∏´‡∏ç‡πà", "‡∏´‡∏¥‡∏ô‡∏¢‡πà‡∏≠‡∏¢", "‡∏ó‡∏£‡∏≤‡∏¢‡∏´‡∏¢‡∏≤‡∏ö", "‡∏õ‡∏π‡∏ô‡∏ã‡∏µ‡πÄ‡∏°‡∏ô‡∏ï‡πå", "‡∏´‡∏¥‡∏ô‡∏Ñ‡∏•‡∏∏‡∏Å"]
            planned_values = {}
            for i, name in enumerate(p_names):
                planned_values[name] = col_plan[i].number_input(f"‡πÅ‡∏ú‡∏ô: {name}", min_value=0.0, key=f"p_{i}")

        st.divider()

        # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô
        st.subheader("‚ûï 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏à‡∏£‡∏¥‡∏á")
        col_in1, col_in2, col_in3 = st.columns([2, 1, 1])
        work_list = df[0].dropna().unique().tolist()
        selected_work = col_in1.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô:", work_list)
        quantity = col_in2.number_input("‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á:", min_value=0.1, value=1.0)
        
        if col_in3.button("‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"):
            selected_row = df[df[0] == selected_work].iloc[0]
            m_map = {"‡∏´‡∏¥‡∏ô‡πÉ‡∏´‡∏ç‡πà": 2, "‡∏´‡∏¥‡∏ô‡∏¢‡πà‡∏≠‡∏¢": 4, "‡∏ó‡∏£‡∏≤‡∏¢‡∏´‡∏¢‡∏≤‡∏ö": 6, "‡∏õ‡∏π‡∏ô‡∏ã‡∏µ‡πÄ‡∏°‡∏ô‡∏ï‡πå": 8, "‡∏´‡∏¥‡∏ô‡∏Ñ‡∏•‡∏∏‡∏Å": 10}
            temp_details = {}
            for m_name, idx in m_map.items():
                try:
                    if idx < len(selected_row):
                        rate_val = float(selected_row[idx])
                        if rate_val > 0: temp_details[m_name] = rate_val * quantity
                except: continue
            st.session_state.calc_history.append({"‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô": selected_work, "‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô": quantity, "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î": temp_details})
            st.rerun()

        # ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        if st.session_state.calc_history:
            st.subheader("üìã 3. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∞‡∏™‡∏°")
            for i, item in enumerate(st.session_state.calc_history):
                with st.expander(f"üîπ {item['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô']} | {item['‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô']} ‡∏´‡∏ô‡πà‡∏ß‡∏¢", expanded=False):
                    for m_n, m_v in item['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'].items():
                        st.write(f"- {m_n}: **{m_v:,.2f}**")
                    if st.button(f"üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ", key=f"del_{i}"):
                        st.session_state.calc_history.pop(i)
                        st.rerun()

            # ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
            st.divider()
            st.subheader("üìä 4. ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ú‡∏ô")
            
            totals = {k: 0.0 for k in p_names}
            for item in st.session_state.calc_history:
                for m_n, m_v in item['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'].items():
                    # Matching name
                    for p_n in p_names:
                        if p_n in m_n: totals[p_n] += m_v

            # ‡πÅ‡∏™‡∏î‡∏á Metric ‡∏™‡∏µ‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î
            m_cols = st.columns(len(p_names))
            for i, name in enumerate(p_names):
                m_cols[i].metric(label=name, value=f"{totals[name]:,.2f}")

            # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ
            comp_rows = []
            for name in p_names:
                p_val = planned_values[name]
                a_val = totals[name]
                diff = p_val - a_val
                comp_rows.append({
                    "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏™‡∏î‡∏∏": name,
                    "‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô": p_val,
                    "‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏£‡∏¥‡∏á": a_val,
                    "‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á": diff,
                    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞": "‚úÖ OK" if diff >= 0 else "‚ö†Ô∏è Over"
                })
            st.table(pd.DataFrame(comp_rows))

            # --- ‡∏™‡πà‡∏ß‡∏ô EXPORT ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° ---
            st.subheader("üì§ 5. ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
            
            # 1. ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Detailed)
            export_detailed = []
            for item in st.session_state.calc_history:
                row = {"‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô": item['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô'], "‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á": item['‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô']}
                # ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß
                for name in p_names:
                    val = 0.0
                    for m_n, m_v in item['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'].items():
                        if name in m_n: val = m_v
                    row[name] = val
                export_detailed.append(row)
            
            df_detailed = pd.DataFrame(export_detailed)
            
            # 2. ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (Comparison)
            df_comp = pd.DataFrame(comp_rows)
            
            # ‡∏£‡∏ß‡∏°‡πÑ‡∏ü‡∏•‡πå CSV (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á)
            output_text = f"‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: {project_name}\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì: {calc_date}\n\n"
            output_text += "--- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ---\n"
            output_text += df_detailed.to_csv(index=False)
            output_text += "\n--- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ú‡∏ô ---\n"
            output_text += df_comp.to_csv(index=False)
            
            col_ex1, col_ex2 = st.columns(2)
            col_ex1.download_button(
                label="üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå",
                data=output_text.encode('utf-8-sig'),
                file_name=f'Report_{project_name}_{calc_date}.csv',
                mime='text/csv',
                use_container_width=True
            )
            if col_ex2.button("üö´ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"):
                st.session_state.calc_history = []
                st.rerun()

    else:
        st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå data.csv")
except Exception as e:
    st.error(f"‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
